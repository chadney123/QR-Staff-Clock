<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Staff Scan</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-slate-900 min-h-screen flex flex-col items-center font-sans text-white">

    <div class="w-full max-w-md p-8 text-center">
        <h1 class="text-3xl font-black tracking-tight text-indigo-400">CHECK-IN</h1>
        <p class="text-slate-400 text-sm">Step 1: Enter Name & Scan Code</p>
    </div>

    <main class="w-full max-w-md px-6 space-y-6">
        
        <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-xl">
            <label class="block text-xs font-bold uppercase text-indigo-400 mb-2">Staff Name</label>
            <input type="text" id="staffName" placeholder="Your Name" oninput="saveName(this.value)"
                   class="w-full p-4 bg-slate-900 border-2 border-slate-700 rounded-2xl focus:border-indigo-500 outline-none text-xl text-white">
        </div>

        <div class="relative bg-black rounded-[2rem] overflow-hidden border-2 border-slate-700 shadow-2xl">
            <div id="reader" class="w-full"></div>
            <div id="lock-overlay" class="absolute inset-0 bg-slate-900/80 flex items-center justify-center text-center p-6 transition-opacity duration-500">
                <p class="font-bold text-indigo-300">Enter name above to start scanner</p>
            </div>
        </div>

        <div id="action-area" class="opacity-30 pointer-events-none transition-all duration-500">
            <p class="text-center text-xs font-bold text-emerald-400 mb-3 uppercase tracking-widest">Location Scanned! Now Choose:</p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="submitRecord('IN')" class="py-5 rounded-3xl font-black text-lg bg-emerald-500 text-white shadow-lg active:scale-95 transition-transform">CLOCK IN</button>
                <button onclick="submitRecord('OUT')" class="py-5 rounded-3xl font-black text-lg bg-rose-500 text-white shadow-lg active:scale-95 transition-transform">CLOCK OUT</button>
            </div>
            <p id="locationName" class="text-center mt-3 text-slate-400 font-mono text-sm"></p>
        </div>
        
        <p id="status" class="text-center text-xs text-slate-500 pb-10 uppercase italic">Waiting for scan...</p>
    </main>

    <script>
        let scannedLocation = "";
        const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbwYka27wEPw0aecv0upJCH9TjKTNh-RDdGGQ0QLQaov8ETV3Y6CfW6AgRAR7jXK0IBiIA/exec"; 

        window.onload = () => {
            const savedName = localStorage.getItem('staffName');
            if (savedName) {
                document.getElementById('staffName').value = savedName;
                unlockScanner();
            }
        };

        function saveName(val) {
            localStorage.setItem('staffName', val);
            if(val.length > 2) unlockScanner();
        }

        function unlockScanner() {
            document.getElementById('lock-overlay').classList.add('opacity-0', 'pointer-events-none');
            startScanner();
        }

        function startScanner() {
            const scanner = new Html5QrcodeScanner("reader", { 
                fps: 10, 
                qrbox: {width: 250, height: 250},
                rememberLastUsedCamera: true,
                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
            });
            scanner.render(onScanSuccess);
        }

        function onScanSuccess(decodedText) {
            scannedLocation = decodedText;
            // Reveal the In/Out buttons
            document.getElementById('action-area').classList.remove('opacity-30', 'pointer-events-none');
            document.getElementById('locationName').innerText = "Location: " + decodedText;
            document.getElementById('status').innerText = "âœ… Scan Complete. Tap In or Out.";
            
            // Subtle vibrate for haptic feedback
            if (navigator.vibrate) navigator.vibrate(100);
        }

        function submitRecord(type) {
            const name = document.getElementById('staffName').value;
            document.getElementById('status').innerText = "ðŸš€ SENDING...";

            fetch(GOOGLE_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ name: name, action: type, location: scannedLocation })
            }).then(() => {
                alert(`âœ… ${type} Recorded!`);
                location.reload(); // Reset app for next scan
            }).catch(err => alert("Error: " + err));
        }

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    </script>
</body>
</html>
